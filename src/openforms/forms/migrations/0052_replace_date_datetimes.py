# Generated by Django 3.2.16 on 2022-11-08 12:54
from datetime import datetime

from django.db import migrations
import json
import re

from openforms.utils.date import get_date_in_current_timezone


def replace_dates_with_datetimes(apps, schema_editor):
    FormLogic = apps.get_model("forms", "FormLogic")
    rules = FormLogic.objects.all()

    pattern = r'\{"date": "(....-..-..)"\}'

    def replace_date(matchobj):
        date_str = matchobj.group(1)
        parsed_datetime = datetime.fromisoformat(date_str)
        datetime_str = get_date_in_current_timezone(parsed_datetime)
        return json.dumps({"date": datetime_str})

    updated_rules = []
    for rule in rules:
        rule_modified = False
        for field in ["json_logic_trigger", "actions"]:
            string_json = json.dumps(getattr(rule, field))
            updated_json = re.sub(pattern, replace_date, string_json)
            if string_json != updated_json:
                rule_modified = True
                setattr(rule, field, json.loads(updated_json))

        if rule_modified:
            updated_rules.append(rule)

    FormLogic.objects.bulk_update(
        updated_rules, fields=["json_logic_trigger", "actions"]
    )


class Migration(migrations.Migration):

    dependencies = [
        ("forms", "0051_update_translation_fields"),
    ]

    operations = [
        migrations.RunPython(replace_dates_with_datetimes, migrations.RunPython.noop),
    ]
